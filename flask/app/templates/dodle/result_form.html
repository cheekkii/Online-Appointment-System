{% extends "dodle/base.html" %} 
{% block styles %}

<style>

    .main_info{
        margin-bottom:30px;
    }

    .main_page {
        width: 60%;       
        margin: 0 auto; 
    }

    .info_user{
        display: block;
        gap : 10px;
    }

    .info_user > * {
        margin-bottom: 10px;
    }

    .people_selected{
        border: 1px solid black;
        background-color: green;
        border-radius:5px;
        padding: 10px;
    }

    .people_selected p{
        margin:0px;
        padding:0px;
    }
    
    .info_all{
        margin: 0 auto; 
    }

    .group-poll{
        background-color:rgba(235, 221, 248, 1);
    }
    
    .sign-up-sheet{
        background-color: rgba(255, 188, 249, 0.4);
    }
    
    .booking-page{
        background-color:rgba(209, 251, 234, 1);
    }
    
    .one-on-one{
        background-color:rgba(201, 228, 255, 1);
    }

    .info_item {
        padding: 20px;
        border: 1px solid black;
        border-radius: 10px;
        background-color: white;  
        margin-bottom:20px;
    }

    .info_item p{
        margin:0px;
        padding:0px;
    }

    #copyBtn{
        cursor: pointer;
    }

    .selected{
        background-color:rgb(129, 191, 248) !important;;
    }

    .block_btn {
        display: flex;
        width: 100%;
        gap:10px;
    }
    
    .btn_group_poll {
        flex-grow: 1;
        width: 100%;
        min-height: 80px; /* ปรับความสูงขั้นต่ำให้ปุ่มเท่ากัน */
        display: flex;
        flex-direction: column; /* ให้ text อยู่ตรงกลาง */
        align-items: center;
        justify-content: center;
        text-align: center;
        border: 1px solid black;
        border-radius:10px;
        background-color:rgb(201, 226, 255);
        cursor: pointer;
        transition: background 0.3s;
    }
    
    .confirm{
        border: 1px solid black;
        border-radius:30px;
        background-color:#FDEDD2;
        max-width:400px;
        height:50px;
        transition: transform 0.2s ease, background-color 0.2s ease;
    }

    .confirm:hover{
        transform: scale(1.1);
        background-color:#000000;
        color:rgb(255, 255, 255)

    }

    #linkText {
        word-break: break-word; /* ตัดคำเมื่อเกินขอบ */
        white-space: normal; /* ให้ข้อความขึ้นบรรทัดใหม่ */
        overflow-wrap: break-word; /* ทำให้คำที่ยาวมากถูกตัดบรรทัด */
        max-width: 100%; /* ป้องกันข้อความล้นขอบ */
    }

    .info_link{
        display:flex;
        flex-direction:row;
    }

    .btn_confirm{
        display:flex;
        justify-content:center;
    }

    .btn_group_poll p{
        margin:0px;
        padding:0px;
    }

    #delete_form{
        border: 1px solid black;
        font-size:20px;
        padding:20px;
        border-radius:10px;
    }
    
    .header{
        display:flex;
        justify-content:space-between
    }

</style>

{% endblock styles %}

{% block content %}
<a href="/dodle/home" class="go_back_home">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor" width='30' height='30' class="size-6">
        <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18" />
    </svg>                         
</a>
    
<div class='main_page'>
    <div class='main_info'>
        <div class='header'>
            <div>
                <h3 class='title'>{{info_form[0]['title']}}</h3>
                <h5 class='type_form'>{{info_form[0]['form_type']}}</h5>
            </div>
            <div class='delete_form'>
                <button class='{{info_form[0]['form_type']}}' id='delete_form'>Delete Form</button>
            </div>   
        </div>
        <div class='info_user'>
            <div class='info_link'>
                <svg id="copyBtn" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6" width='30' height='30'>
                    <path stroke-linecap="round" stroke-linejoin="round" 
                        d="M13.19 8.688a4.5 4.5 0 0 1 1.242 7.244l-4.5 4.5a4.5 4.5 0 0 1-6.364-6.364l1.757-1.757m13.35-.622 1.757-1.757a4.5 4.5 0 0 0-6.364-6.364l-4.5 4.5a4.5 4.5 0 0 0 1.242 7.244" />
                </svg>
                <p id="linkText" onclick="window.location.href='{{ next_page }}'">{{ next_page }}</p>
            </div>
        </div> 
    </div>


    <div class='row info_all'></div>

    <div class='selected_poll'>
    </div>

    <div class='btn_confirm'>
    </div>


    <!-- ADDED FOR CSRF by tanya -->
    <input type="hidden" name="csrf_token" class="csrf_token" value="{{ csrf_token() }}" />

</div>









<script>



    $('#delete_form').click(function(){
        if(!confirm("are you sure you want to delete this post?")){
            return;
          }
          var csrf_token = $('.csrf_token').val();
          $.post("/dodle/remove-form", {"form_id" : {{info_form[0]['id']}}, "csrf_token": csrf_token},function(response){
            console.log(response);

            if(response == "deleted"){
              window.location.href = "/dodle/home";
              alert("delete successfuly!");
            }
        });
    });


    var all_form = {{ info_form|tojson }}[0];
    console.log('allllllllll',all_form);
    if (all_form['form_type'] == 'group-poll'){
        var btn_new = ` <button class='confirm' id='confirm_selection'>Confirm Selected</button>`;
        $('.btn_confirm').empty();
        $('.btn_confirm').append(btn_new);

        var url1 = `/dodle/get-all-form-items/{{form_id}}`;
        $.getJSON(url1, function(response) {
            var all_item = response;
            var select_poll = $('.selected_poll');
            select_poll.empty(); // ล้างข้อมูลเก่า
            
            var text_1 = `<p>Summarize poll results</p>`;
            select_poll.append(text_1);
    
            // เพิ่ม .btn_data กลับเข้าไปใหม่
            select_poll.append(`<div class='row btn_data'></div>`);
            
            var btn_data = $('.btn_data'); // ต้องเรียกใหม่หลังจากที่เพิ่มเข้าไปแล้ว
            btn_data.empty();
            for(var item of response){
                console.log(item['id'])
                var btn_select_form = `
                    <div class='col-md-3 col-sm-6 mb-3'>
                        <div class='block_btn'>
                            <button class='btn_group_poll' id='btn_group_poll_${item['id']}' value='${item['date']}-${item['start_time']}-${item['end_time']}'>
                                <p>${item['date']}</p>
                                <p>${item['start_time']} - ${item['end_time']}</p>
                            </button>
                        </div>
                    </div>
                `;
                btn_data.append(btn_select_form);
            };
        });
    }

    $(document).on('click', '.btn_group_poll', function(){
        console.log('ปุ่มถูกคลิก:', this);  // ตรวจสอบว่าโค้ดทำงาน
        $('.btn_group_poll').removeClass('selected');  
        $(this).addClass('selected');  
    });

    var message;
    $(document).on('click', '#confirm_selection', function(){
        var selected_btn = $('.btn_group_poll.selected'); // ค้นหาปุ่มที่ถูกเลือก
        if (selected_btn.length > 0) {
            var selected_value = selected_btn.val().split('-'); // ดึงค่า value ของปุ่มที่เลือก
            console.log('Confirmed Selection:', selected_value);
            message = "On " + selected_value[0] + ", from " + selected_value[1] + " to " + selected_value[2] + ", you have appointed " + all_form['title'] + " at " + all_form['location'] + 
            " the vote has been finalised by the organizer and we hope you can make your attendance. the event will last about " + all_form['duration'];
            console.log('message', message);
            
            //make a post request to invoke that mail server
            var url2 = `/dodle/get-all-form-participants/{{form_id}}`;
            $.getJSON(url2, function (form_participants) {
                var user = form_participants;
                for(var u of user){
                    //console.log(u);
                    var dic = {
                        "title": all_form['title'],
                        "message": message,
                        "email": u['email']
                    };
                    dic['csrf_token'] = $('.csrf_token').val();
                    console.log(dic);
                    $.post('/send-mail', dic , function (response) {
                        console.log(response);
                    });
                }
            });

        } else {
            alert("pleast select time first!");
        }
    });
    
    



//--------------------------------------------ดึงดาต้าของฟอร์มมา----------------------------------------//
function getdata() {
    var url1 = `/dodle/get-all-form-items/{{form_id}}`;
    var url2 = `/dodle/get-all-form-participants/{{form_id}}`;

    return new Promise((resolve, reject) => {
        $.getJSON(url1, function(response1) {
            console.log('Items:', response1);

            $.getJSON(url2, function(response2) {
                console.log('Participants:', response2);
                resolve({ all_item: response1, all_paticipant: response2 });
            }).fail(reject);
        }).fail(reject);
    });
}

// ใช้ async/await เพื่อจัดการกับข้อมูล
async function loadData() {
    try {
        const { all_item, all_paticipant } = await getdata();  // รอจนข้อมูลทั้งหมดถูกโหลดเสร็จ

        var list_per = {};  // สร้างตัวแปร list_per
        for (var per of all_paticipant) {
            var person_id = per['id'];
            list_per[`${per['email']}-${per['name']}-${per['id']}`] = [];
            var url3 = `/dodle/get-all-form-participant-choices/${person_id}`;

            // รอให้การดึงข้อมูลจาก url3 เสร็จ
            const response = await $.getJSON(url3);
            //console.log('res', response);
            list_per[`${per['email']}-${per['name']}-${per['id']}`] = response ;
        }

        // แสดงผลหลังข้อมูลทั้งหมดถูกดึงมาเสร็จ
        console.log('List per:', list_per);
        console.log('all_item', all_item);
        var info_all = $('.info_all');
        info_all.empty();
        for (var item of all_item) {
            var new_item = `
                <div class='col-md-6 g-3'>
                    <div class='info_item'>
                        <h4 id="date_${item['id']}">${item['date']}</h4>
                        <p id="time_${item['id']}">${item['start_time']} - ${item['end_time']}</p>
                        <div class='info_user' id='info_user_${item['id']}'></div>
                    </div>
                </div>
            `;
            info_all.append(new_item);

            var info_user = $(`#info_user_${item['id']}`);
            for (var key in list_per) {
                for(var obj of list_per[key]){
                    //console.log(obj);
                    if(obj['form_item_id'] == item['id']){
                        var data = key.split('-');
                        var new_time = `
                            <div class='people_selected {{info_form[0]['form_type']}}'>
                                <p>${data[1]}</p>
                                <p>${data[0]}</p>
                            </div>
                        `;
                        info_user.append(new_time);
                    } 
                }
            }
        }

    } catch (error) {
        console.error('Error loading data:', error);
    }
}

// เรียกใช้ฟังก์ชัน loadData
loadData();

$(document).ready(function() {
    $(document).ready(function() {
        $("#copyBtn").click(function(event) {
            event.stopPropagation(); // ป้องกันการพาไปหน้าอื่นเมื่อกด SVG
            var link = $("#linkText").text(); // ดึงค่าลิงก์
            navigator.clipboard.writeText(link).then(function() {
                alert("copy link already!");
            }).catch(function(err) {
                console.error("copy link fail:", err);
            });
        });
    });
});

</script>

{% endblock content %}
